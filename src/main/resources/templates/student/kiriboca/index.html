<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í‚¤ë¦¬ë³´ì¹´</title>

    <!-- CSS íŒŒì¼ë“¤ ë§í¬ -->
    <link rel="stylesheet" th:href="@{/student/kiriboca/css/main.css}">
    <link rel="stylesheet" th:href="@{/student/kiriboca/css/sidebar.css}">
    <link rel="stylesheet" th:href="@{/student/kiriboca/css/dashboard.css}">
    <link rel="stylesheet" th:href="@{/student/kiriboca/css/profile.css}">
    <link rel="stylesheet" th:href="@{/student/kiriboca/css/admin.css}">
    <link rel="stylesheet" th:href="@{/student/kiriboca/css/admin-student-management.css}">

    <!-- Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <!-- ì¤‘ë³µ ë¡œë“œ ë°©ì§€ ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        // ì¤‘ë³µ ì„ ì–¸ ë°©ì§€
        if (typeof window.EnhancedIntegratedLearningManager !== 'undefined') {
            delete window.EnhancedIntegratedLearningManager;
        }
        if (typeof window.enhancedIntegratedLearningManager !== 'undefined') {
            delete window.enhancedIntegratedLearningManager;
        }
        if (typeof window.DarkModeManager !== 'undefined') {
            delete window.DarkModeManager;
        }
        if (typeof window.CardChangeManager !== 'undefined') {
            delete window.CardChangeManager;
        }
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #f8f9fa;
        }

        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        #sidebar-container {
            width: 250px;
            flex-shrink: 0;
            border-right: 1px solid #e9ecef;
            /*background: white;*/
        }

        #main-content-container {
            flex: 1;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #52C41A;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #666;
            font-size: 16px;
        }

        /* í˜ì´ì§€ ì»¨í…Œì´ë„ˆ */
        .page-container {
            display: none;
            width: 100%;
            margin: 0;
            padding: 20px 30px;
            min-height: 100vh;
        }

        .page-container.active {
            display: block;
        }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* í† ìŠ¤íŠ¸ */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .toast-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .toast-description {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
<!-- ë¡œë”© í™”ë©´ -->
<div id="loading" class="loading">
    <div class="loading-spinner"></div>
    <div class="loading-text">í‚¤ë¦¬ë³´ì¹´ ë¡œë”©ì¤‘...</div>
</div>

<!-- ë©”ì¸ ì•± ì»¨í…Œì´ë„ˆ -->
<div class="app-container">
    <!-- ì‚¬ì´ë“œë°” ì˜ì—­ -->
    <div id="sidebar-container">
        <div th:replace="~{student/kiriboca/components/sidebar :: sidebar}"></div>
    </div>

    <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
    <div id="main-content-container">
        <!-- í•™ìŠµí•˜ê¸° í˜ì´ì§€ (ê¸°ë³¸) -->
        <div id="learning-page" class="page-container active">
            <div th:replace="~{student/kiriboca/components/main-content :: main-content}"></div>
        </div>

        <!-- ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ -->
        <div id="dashboard-page" class="page-container">
            <div th:replace="~{student/kiriboca/components/dashboard :: dashboard-content}"></div>
        </div>

        <!-- í”„ë¡œí•„ í˜ì´ì§€ -->
        <div id="profile-page" class="page-container">
            <div th:replace="~{student/kiriboca/components/profile :: profile-content}"></div>
        </div>

        <!-- ê´€ë¦¬ì í˜ì´ì§€ -->
        <div id="admin-page" class="page-container">
            <div th:replace="~{student/kiriboca/components/admin :: admin-content}"></div>
        </div>

        <!-- í•™ìƒ ê´€ë¦¬ í˜ì´ì§€ (ADMIN, TEACHER ì „ìš©) -->
        <div id="admin-student-management-page" class="page-container">
            <div th:replace="~{student/kiriboca/components/admin-student-management :: adminStudentManagement}"></div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script th:inline="javascript">
    <!-- í‚¤ë¦¬ë³´ì¹´ ì•± í´ë˜ìŠ¤ -->
    class KiribocaApp {
        constructor() {
            this.currentPage = 'learning';
            this.isLoading = false;
            this.wordsLearned = 0;
            this.sentencesLearned = 0;
            this.totalCoins = 0;
            this.learnedWords = new Map(); // wordId -> {text, translation, time}
            this.learnedSentences = new Map(); // sentenceId -> {text, translation, time}
            this.favoriteWords = new Set();
            this.init();
        }

        // ì•± ì´ˆê¸°í™”
        async init() {
            console.log('ğŸš€ í‚¤ë¦¬ë³´ì¹´ ì•± ì‹œì‘');

            try {
                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                this.setupEventListeners();

                // API ì—°ê²° ìƒíƒœ í™•ì¸ ë° ì¬ì‹œë„
                await this.checkApiConnection();

                // ë¡œë”© ì™„ë£Œ
                this.hideLoading();

                // ì˜¤ëŠ˜ í•™ìŠµ ì§„í–‰ìƒí™© ë¶ˆëŸ¬ì˜¤ê¸°
                await this.fetchTodayProgress();

                console.log('âœ… í‚¤ë¦¬ë³´ì¹´ ì•± ë¡œë“œ ì™„ë£Œ');
            } catch (error) {
                console.error('âŒ ì•± ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
                /*this.showToast('ì˜¤ë¥˜', 'ì•±ì„ ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');*/
            }
        }

        // API ì—°ê²° ìƒíƒœ í™•ì¸
        async checkApiConnection() {
            console.log('ğŸ” API ì—°ê²° ìƒíƒœ í™•ì¸');

            try {
                const response = await fetch('/api/sidebar/levels');
                if (!response.ok) {
                    console.log('âš ï¸ API ì—°ê²° ì‹¤íŒ¨, ì¬ì‹œë„ ì¤‘...');
                    // 3ì´ˆ í›„ ì¬ì‹œë„
                    setTimeout(() => {
                        location.reload();
                    }, 3000);
                } else {
                    console.log('âœ… API ì—°ê²° ì„±ê³µ');
                }
            } catch (error) {
                console.error('âŒ API ì—°ê²° í™•ì¸ ì‹¤íŒ¨:', error);
                this.showToast('ì—°ê²° ì˜¤ë¥˜', 'API ì„œë²„ì™€ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        setupEventListeners() {
            console.log('ğŸ”— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •');

            setTimeout(() => {
                this.setupNavigationEvents();

                // í–¥ìƒëœ í†µí•© í•™ìŠµ ê´€ë¦¬ìê°€ ìˆìœ¼ë©´ í•™ìŠµ ì´ë²¤íŠ¸ëŠ” ì„¤ì •í•˜ì§€ ì•ŠìŒ
                if (!window.enhancedIntegratedLearningManager) {
                this.setupLearningPageEvents();
                } else {
                    console.log('ğŸ”„ í–¥ìƒëœ í†µí•© í•™ìŠµ ê´€ë¦¬ìê°€ ìˆìœ¼ë¯€ë¡œ ê¸°ë³¸ í•™ìŠµ ì´ë²¤íŠ¸ ìŠ¤í‚µ');
                }

                                 this.setupAdminEvents();
                 this.setupProfileEvents();
                 this.updateDisplay();
                 this.updateLearnedLists();
            }, 100);
        }

        // ë„¤ë¹„ê²Œì´ì…˜ ì´ë²¤íŠ¸ ì„¤ì •
        setupNavigationEvents() {
            const navItems = document.querySelectorAll('.nav-item[data-page]');

            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = item.dataset.page;

                    if (page && page !== this.currentPage) {
                        this.navigateTo(page);
                    }
                });

                // í˜¸ë²„ íš¨ê³¼
                item.addEventListener('mouseenter', () => {
                    if (!item.classList.contains('active')) {
                        item.style.transform = 'translateX(2px)';
                        /*item.style.background = '#f8f9fa';*/
                    }
                });

                item.addEventListener('mouseleave', () => {
                    if (!item.classList.contains('active')) {
                        item.style.transform = 'translateX(0)';
                        item.style.background = 'none';
                    }
                });
            });

            console.log('ğŸ§­ ë„¤ë¹„ê²Œì´ì…˜ ì´ë²¤íŠ¸ ì„¤ì • ì™„ë£Œ');
        }

        // í•™ìŠµ í˜ì´ì§€ ì´ë²¤íŠ¸ ì„¤ì •
        setupLearningPageEvents() {
            console.log('ğŸ“š í•™ìŠµ í˜ì´ì§€ ì´ë²¤íŠ¸ ì„¤ì •');

            // í–¥ìƒëœ í†µí•© í•™ìŠµ ê´€ë¦¬ìê°€ ìˆìœ¼ë©´ ê¸°ë³¸ ì´ë²¤íŠ¸ëŠ” ì„¤ì •í•˜ì§€ ì•ŠìŒ
            if (window.enhancedIntegratedLearningManager) {
                console.log('ğŸ”„ í–¥ìƒëœ í†µí•© í•™ìŠµ ê´€ë¦¬ìê°€ ìˆìœ¼ë¯€ë¡œ ê¸°ë³¸ í•™ìŠµ ì´ë²¤íŠ¸ ìŠ¤í‚µ');
                return;
            }

            // ë‹¨ì–´ ì¹´ë“œ ì´ë²¤íŠ¸
            const wordCards = document.querySelectorAll('.word-card');
            wordCards.forEach(card => {
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('.word-favorite')) {
                        this.handleWordClick(card);
                    }
                });

                // ì¦ê²¨ì°¾ê¸° ë²„íŠ¼
                const favoriteBtn = card.querySelector('.word-favorite');
                if (favoriteBtn) {
                    favoriteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.toggleWordFavorite(card);
                    });
                }
            });

            // ë¬¸ì¥ ì¹´ë“œ ì´ë²¤íŠ¸
            const sentenceCards = document.querySelectorAll('.sentence-card');
            sentenceCards.forEach(card => {
                card.addEventListener('click', () => {
                    this.handleSentenceClick(card);
                });
            });

                         // Start ë²„íŠ¼ ì´ë²¤íŠ¸
             const wordsStartBtn = document.getElementById('words-start-btn');
             const sentencesStartBtn = document.getElementById('sentences-start-btn');
             
             if (wordsStartBtn) {
                 wordsStartBtn.addEventListener('click', () => {
                     this.handleWordsStart();
                 });
             }
             
             if (sentencesStartBtn) {
                 sentencesStartBtn.addEventListener('click', () => {
                     this.handleSentencesStart();
                 });
             }

            // ê²€ìƒ‰ ê¸°ëŠ¥
            const searchInput = document.querySelector('.search-input');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    this.handleSearch(e.target.value);
                });
            }
        }

        // ê´€ë¦¬ì ì´ë²¤íŠ¸ ì„¤ì •
        setupAdminEvents() {
            console.log('âš™ï¸ ê´€ë¦¬ì ì´ë²¤íŠ¸ ì„¤ì •');

            // ê¸°ì¡´ navigateTo ë©”ì„œë“œë¥¼ í™•ì¥í•˜ì—¬ ê´€ë¦¬ì í˜ì´ì§€ ì§„ì… ì‹œ AdminDashboard ì´ˆê¸°í™”
            const originalNavigateTo = this.navigateTo.bind(this);

            this.navigateTo = function(page) {
                console.log(`ğŸ“„ í˜ì´ì§€ ì´ë™: ${this.currentPage} â†’ ${page}`);

                // ê¸°ì¡´ ë„¤ë¹„ê²Œì´ì…˜ ë¡œì§ ì‹¤í–‰
                originalNavigateTo(page);

                // ê´€ë¦¬ì í˜ì´ì§€ë¡œ ì „í™˜ëœ ê²½ìš° AdminDashboard ì´ˆê¸°í™”
                if (page === 'admin') {
                    console.log('ğŸ”§ ê´€ë¦¬ì í˜ì´ì§€ ì§„ì… - AdminDashboard ì´ˆê¸°í™” ì˜ˆì•½');

                    // íŒŒì¼ ë¡œë“œ í™•ì¸ ë° ì´ˆê¸°í™”
                    const initAdmin = () => {
                        console.log('ğŸ”§ AdminDashboard ì´ˆê¸°í™” ì‹¤í–‰');

                        // admin.jsì˜ ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
                        if (typeof window.initAdminDashboard === 'function') {
                            window.initAdminDashboard();
                            console.log('âœ… AdminDashboard ì´ˆê¸°í™” ì™„ë£Œ');
                        } else {
                            console.error('âŒ admin.jsê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. íŒŒì¼ ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”.');
                            console.log('ğŸ” ë””ë²„ê·¸: window ê°ì²´ì—ì„œ admin ê´€ë ¨ í•¨ìˆ˜ë“¤:',
                                Object.keys(window).filter(key => key.includes('admin') || key.includes('Admin')));

                            // ì¬ì‹œë„ ë¡œì§ ì¶”ê°€
                            console.log('ğŸ”„ admin.js ë¡œë“œ ì¬ì‹œë„ ì¤‘...');
                            setTimeout(() => {
                                if (typeof window.initAdminDashboard === 'function') {
                                    window.initAdminDashboard();
                                    console.log('âœ… AdminDashboard ì¬ì‹œë„ ì´ˆê¸°í™” ì™„ë£Œ');
                                } else {
                                    console.error('âŒ admin.js ë¡œë“œ ì‹¤íŒ¨ - ìˆ˜ë™ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                                }
                            }, 1000);
                        }
                    };

                    // DOMì´ ì™„ì „íˆ ë¡œë“œë  ë•Œê¹Œì§€ ì¶©ë¶„íˆ ëŒ€ê¸°
                    setTimeout(initAdmin, 300);
                }
            };
        }

        // í”„ë¡œí•„ ì´ë²¤íŠ¸ ì„¤ì •
        setupProfileEvents() {
            console.log('ğŸ‘¤ í”„ë¡œí•„ ì´ë²¤íŠ¸ ì„¤ì •');

            setTimeout(() => {
                // í† ê¸€ ìŠ¤ìœ„ì¹˜ ê¸°ëŠ¥
                const toggleSwitches = document.querySelectorAll('.toggle-switch input');
                toggleSwitches.forEach(toggle => {
                    toggle.addEventListener('change', (e) => {
                        console.log(`ì„¤ì • ë³€ê²½: ${e.target.id} = ${e.target.checked}`);
                        this.showToast('ì„¤ì • ë³€ê²½', `${e.target.id} ì„¤ì •ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    });
                });

                // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
                const updateBtns = document.querySelectorAll('.update-btn, .avatar-btn');
                updateBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const btnText = e.target.textContent;
                        this.showToast('ê¸°ëŠ¥ ì¤€ë¹„ì¤‘', `${btnText} ê¸°ëŠ¥ì€ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤.`);
                    });
                });
            }, 200);
        }

        // í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜ (ê¸°ì¡´ ë©”ì„œë“œëŠ” setupAdminEventsì—ì„œ ì˜¤ë²„ë¼ì´ë“œë¨)
        navigateTo(page) {
            console.log(`ğŸ“„ í˜ì´ì§€ ì´ë™: ${this.currentPage} â†’ ${page}`);

            if (this.isLoading) {
                console.log('â³ ì´ë¯¸ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...');
                return;
            }

            // íŠ¹ë³„ ì²˜ë¦¬ (ë¡œê·¸ì•„ì›ƒ)
            if (page === 'logout') {
                window.location.replace('/logout');
                return;
            }

            // ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
            this.updateNavigationState(page);

            // í˜ì´ì§€ ì „í™˜
            this.switchPage(page);

            // í•™ìƒ ê´€ë¦¬ í˜ì´ì§€ì¸ ê²½ìš° StudentManagementManager ì´ˆê¸°í™”
            if (page === 'admin-student-management') {
                console.log('ğŸ”§ í•™ìƒ ê´€ë¦¬ í˜ì´ì§€ ì§„ì… - StudentManagementManager ì´ˆê¸°í™”');
                setTimeout(() => {
                    if (typeof window.initStudentManagementManager === 'function') {
                        window.initStudentManagementManager();
                        console.log('âœ… StudentManagementManager ì´ˆê¸°í™” ì™„ë£Œ');
                    } else {
                        console.error('âŒ admin-student-management.jsê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                    }
                }, 100);
            }

            this.currentPage = page;
        }

        // í˜ì´ì§€ ì „í™˜
        switchPage(targetPage) {
            // ëª¨ë“  í˜ì´ì§€ ìˆ¨ê¸°ê¸°
            const allPages = document.querySelectorAll('.page-container');
            allPages.forEach(page => {
                page.classList.remove('active');
            });

            // ëŒ€ìƒ í˜ì´ì§€ í‘œì‹œ
            let targetPageElement;
            
            // í˜ì´ì§€ ID ë§¤í•‘
            const pageIdMap = {
                'learning': 'learning-page',
                'dashboard': 'dashboard-page',
                'profile': 'profile-page',
                'admin': 'admin-page',
                'admin-student-management': 'admin-student-management-page'
            };
            
            const pageId = pageIdMap[targetPage] || `${targetPage}-page`;
            targetPageElement = document.getElementById(pageId);
            
            if (targetPageElement) {
                targetPageElement.classList.add('active');
                targetPageElement.classList.add('fade-in');
                console.log(`âœ… í˜ì´ì§€ ì „í™˜ ì™„ë£Œ: ${targetPage} (${pageId})`);
            } else {
                console.error(`âŒ í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${pageId}`);
            }
        }

        // ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateNavigationState(page) {
            // ëª¨ë“  ë„¤ë¹„ê²Œì´ì…˜ ì•„ì´í…œ ë¹„í™œì„±í™”
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // ìƒˆë¡œìš´ í™œì„± ë„¤ë¹„ê²Œì´ì…˜ ì•„ì´í…œ ì„¤ì •
            const activeNavItem = document.querySelector(`[data-page="${page}"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
                console.log(`ğŸ§­ ë„¤ë¹„ê²Œì´ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸: ${page}`);
            } else {
                console.warn(`âš ï¸ ë„¤ë¹„ê²Œì´ì…˜ ì•„ì´í…œì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${page}`);
            }
        }

        // í˜ì´ì§€ ì œëª© ë°˜í™˜
        getPageTitle(page) {
            const titles = {
                'learning': 'í•™ìŠµí•˜ê¸°',
                'dashboard': 'ëŒ€ì‹œë³´ë“œ',
                'profile': 'í”„ë¡œí•„',
                'admin': 'ê´€ë¦¬ì'
            };
            return titles[page] || page;
        }

                 // ë‹¨ì–´ í´ë¦­ ì²˜ë¦¬
         handleWordClick(card) {
             const wordId = card.dataset.word || Math.random().toString(36).substr(2, 9);
             const wordText = card.querySelector('.word-english')?.textContent || 'Unknown Word';
             const wordTranslation = card.querySelector('.word-korean')?.textContent || '';

             // TTS ì¬ìƒ
             this.speakText(wordText);

             // ì‹œê°ì  í”¼ë“œë°±
             card.style.transform = 'scale(1.05)';
             setTimeout(() => {
                 card.style.transform = 'scale(1)';
             }, 200);

             // í•™ìŠµ ì™„ë£Œ ì²˜ë¦¬
             if (!this.learnedWords.has(wordId)) {
                 const now = new Date();
                 this.learnedWords.set(wordId, {
                     text: wordText,
                     translation: wordTranslation,
                     time: now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
                 });
                 this.wordsLearned++;
                 this.totalCoins += 1;

                 card.style.background = '#e6f7ff';
                 card.style.borderColor = '#91d5ff';

                 this.updateDisplay();
                 this.updateLearnedLists();
                 this.showToast('ë‹¨ì–´ í•™ìŠµ ì™„ë£Œ', `"${wordText}" í•™ìŠµ ì™„ë£Œ! +1 ì½”ì¸`);
             }
         }

                 // ë¬¸ì¥ í´ë¦­ ì²˜ë¦¬
         handleSentenceClick(card) {
             const sentenceId = card.dataset.sentence || Math.random().toString(36).substr(2, 9);
             const sentenceText = card.querySelector('.sentence-text')?.textContent || 'Unknown Sentence';
             const sentenceTranslation = card.querySelector('.sentence-translation')?.textContent || '';

             // TTS ì¬ìƒ
             this.speakText(sentenceText);

             // ì‹œê°ì  í”¼ë“œë°±
             card.style.transform = 'scale(1.02)';
             setTimeout(() => {
                 card.style.transform = 'scale(1)';
             }, 200);

             // í•™ìŠµ ì™„ë£Œ ì²˜ë¦¬
             if (!this.learnedSentences.has(sentenceId)) {
                 const now = new Date();
                 this.learnedSentences.set(sentenceId, {
                     text: sentenceText,
                     translation: sentenceTranslation,
                     time: now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
                 });
                 this.sentencesLearned++;
                 this.totalCoins += 3;

                 card.style.background = '#f6ffed';
                 card.style.borderColor = '#b7eb8f';

                 this.updateDisplay();
                 this.updateLearnedLists();
                 this.showToast('ë¬¸ì¥ í•™ìŠµ ì™„ë£Œ', `"${sentenceText}" í•™ìŠµ ì™„ë£Œ! +3 ì½”ì¸`);
             }
         }

        // ì¦ê²¨ì°¾ê¸° í† ê¸€
        toggleWordFavorite(card) {
            const wordId = card.dataset.word || Math.random().toString(36).substr(2, 9);
            const favoriteBtn = card.querySelector('.word-favorite');

            if (this.favoriteWords.has(wordId)) {
                this.favoriteWords.delete(wordId);
                favoriteBtn.textContent = 'â™¡';
            } else {
                this.favoriteWords.add(wordId);
                favoriteBtn.textContent = 'â¤ï¸';
            }

            // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
            favoriteBtn.style.transform = 'scale(1.3)';
            setTimeout(() => {
                favoriteBtn.style.transform = 'scale(1)';
            }, 200);
        }

                 // ë‹¨ì–´ í•™ìŠµ ì‹œì‘
         handleWordsStart() {
             const wordCards = document.querySelectorAll('.word-card');
             if (wordCards.length === 0) {
                 // ìƒ˜í”Œ ë‹¨ì–´ ì¹´ë“œ ìƒì„±
                 this.generateSampleWords();
                 return;
             }

             let currentIndex = 0;
             const totalCards = wordCards.length;

             const playNext = () => {
                 if (currentIndex >= totalCards) {
                     this.showToast('ë‹¨ì–´ í•™ìŠµ ì™„ë£Œ!', `${totalCards}ê°œì˜ ë‹¨ì–´ë¥¼ ëª¨ë‘ í•™ìŠµí–ˆìŠµë‹ˆë‹¤.`);
                     return;
                 }

                 const card = wordCards[currentIndex];
                 this.handleWordClick(card);
                 currentIndex++;

                 setTimeout(playNext, 2000);
             };

             playNext();
             this.showToast('ë‹¨ì–´ ìë™ í•™ìŠµ ì‹œì‘', 'ëª¨ë“  ë‹¨ì–´ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ í•™ìŠµí•©ë‹ˆë‹¤.');
         }

         // ë¬¸ì¥ í•™ìŠµ ì‹œì‘
         handleSentencesStart() {
             const sentenceCards = document.querySelectorAll('.sentence-card');
             if (sentenceCards.length === 0) {
                 // ìƒ˜í”Œ ë¬¸ì¥ ì¹´ë“œ ìƒì„±
                 this.generateSampleSentences();
                 return;
             }

             let currentIndex = 0;
             const totalCards = sentenceCards.length;

             const playNext = () => {
                 if (currentIndex >= totalCards) {
                     this.showToast('ë¬¸ì¥ í•™ìŠµ ì™„ë£Œ!', `${totalCards}ê°œì˜ ë¬¸ì¥ì„ ëª¨ë‘ í•™ìŠµí–ˆìŠµë‹ˆë‹¤.`);
                     return;
                 }

                 const card = sentenceCards[currentIndex];
                 this.handleSentenceClick(card);
                 currentIndex++;

                 setTimeout(playNext, 3000);
             };

             playNext();
             this.showToast('ë¬¸ì¥ ìë™ í•™ìŠµ ì‹œì‘', 'ëª¨ë“  ë¬¸ì¥ì„ ìˆœì°¨ì ìœ¼ë¡œ í•™ìŠµí•©ë‹ˆë‹¤.');
         }

         // ìƒ˜í”Œ ë‹¨ì–´ ì¹´ë“œ ìƒì„±
         generateSampleWords() {
             const wordsGrid = document.getElementById('words-grid');
             if (!wordsGrid) return;

             const sampleWords = [
                 { english: 'apple', korean: 'ì‚¬ê³¼', audio: 'apple.mp3' },
                 { english: 'banana', korean: 'ë°”ë‚˜ë‚˜', audio: 'banana.mp3' },
                 { english: 'cat', korean: 'ê³ ì–‘ì´', audio: 'cat.mp3' },
                 { english: 'dog', korean: 'ê°•ì•„ì§€', audio: 'dog.mp3' },
                 { english: 'elephant', korean: 'ì½”ë¼ë¦¬', audio: 'elephant.mp3' },
                 { english: 'flower', korean: 'ê½ƒ', audio: 'flower.mp3' },
                 { english: 'garden', korean: 'ì •ì›', audio: 'garden.mp3' },
                 { english: 'house', korean: 'ì§‘', audio: 'house.mp3' },
                 { english: 'ice cream', korean: 'ì•„ì´ìŠ¤í¬ë¦¼', audio: 'icecream.mp3' },
                 { english: 'juice', korean: 'ì£¼ìŠ¤', audio: 'juice.mp3' }
             ];

             const wordsHTML = sampleWords.map((word, index) => `
                 <div class="word-card" data-word="word-${index}">
                     <div class="word-content">
                         <div class="word-english">${word.english}</div>
                         <div class="word-korean">${word.korean}</div>
                     </div>
                     <div class="word-actions">
                         <button class="word-favorite">â™¡</button>
                         <button class="word-audio" onclick="window.kiribocaApp.speakText('${word.english}')">ğŸ”Š</button>
                     </div>
                 </div>
             `).join('');

             wordsGrid.innerHTML = wordsHTML;

             // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë‹¤ì‹œ ì„¤ì •
             this.setupLearningPageEvents();
             this.showToast('ìƒ˜í”Œ ë‹¨ì–´ ë¡œë“œ', '10ê°œì˜ ìƒ˜í”Œ ë‹¨ì–´ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
         }

         // ìƒ˜í”Œ ë¬¸ì¥ ì¹´ë“œ ìƒì„±
         generateSampleSentences() {
             const sentencesGrid = document.getElementById('sentences-grid');
             if (!sentencesGrid) return;

             const sampleSentences = [
                 { english: 'I like apples.', korean: 'ë‚˜ëŠ” ì‚¬ê³¼ë¥¼ ì¢‹ì•„í•©ë‹ˆë‹¤.', audio: 'sentence1.mp3' },
                 { english: 'The cat is sleeping.', korean: 'ê³ ì–‘ì´ê°€ ìê³  ìˆìŠµë‹ˆë‹¤.', audio: 'sentence2.mp3' },
                 { english: 'This is my house.', korean: 'ì´ê²ƒì€ ë‚´ ì§‘ì…ë‹ˆë‹¤.', audio: 'sentence3.mp3' },
                 { english: 'I want ice cream.', korean: 'ì•„ì´ìŠ¤í¬ë¦¼ì„ ì›í•©ë‹ˆë‹¤.', audio: 'sentence4.mp3' },
                 { english: 'The flower is beautiful.', korean: 'ê½ƒì´ ì•„ë¦„ë‹µìŠµë‹ˆë‹¤.', audio: 'sentence5.mp3' }
             ];

             const sentencesHTML = sampleSentences.map((sentence, index) => `
                 <div class="sentence-card" data-sentence="sentence-${index}">
                     <div class="sentence-content">
                         <div class="sentence-text">${sentence.english}</div>
                         <div class="sentence-translation">${sentence.korean}</div>
                     </div>
                     <div class="sentence-actions">
                         <button class="sentence-audio" onclick="window.kiribocaApp.speakText('${sentence.english}')">ğŸ”Š</button>
                     </div>
                 </div>
             `).join('');

             sentencesGrid.innerHTML = sentencesHTML;

             // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë‹¤ì‹œ ì„¤ì •
             this.setupLearningPageEvents();
             this.showToast('ìƒ˜í”Œ ë¬¸ì¥ ë¡œë“œ', '5ê°œì˜ ìƒ˜í”Œ ë¬¸ì¥ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
         }

        // ê²€ìƒ‰ ì²˜ë¦¬
        handleSearch(query) {
            // ê²€ìƒ‰ì–´ê°€ ì§§ìœ¼ë©´ ëª¨ë“  ì¹´ë“œ í‘œì‹œ (ì•„ë¬´ ì¡°ì‘ë„ í•˜ì§€ ì•ŠìŒ)
            if (query.length < 2) {
                return;
            }
            // ê²€ìƒ‰ ê²°ê³¼ í•„í„°ë§ì€ JSì—ì„œ ì§ì ‘ ì¹´ë“œ display/visibilityë¥¼ ì¡°ì‘í•˜ì§€ ì•Šê³ ,
            // main-content.js, app.jsì—ì„œë§Œ ë‹´ë‹¹í•˜ë„ë¡!
        }

        // TTS ìŒì„± ì¬ìƒ
        speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.8;
                speechSynthesis.speak(utterance);
            }
        }

                 // ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸
         updateDisplay() {
             // í—¤ë” ì •ë³´ ì—…ë°ì´íŠ¸
             const wordsLearnedEl = document.getElementById('words-learned');
             const sentencesLearnedEl = document.getElementById('sentences-learned');
             const totalCoinsEl = document.getElementById('total-coins');

             if (wordsLearnedEl) wordsLearnedEl.textContent = this.wordsLearned;
             if (sentencesLearnedEl) sentencesLearnedEl.textContent = this.sentencesLearned;
             if (totalCoinsEl) totalCoinsEl.textContent = this.totalCoins;
         }

         // í•™ìŠµí•œ í•­ëª© ëª©ë¡ ì—…ë°ì´íŠ¸
         updateLearnedLists() {
             this.updateWordsLearnedList();
             this.updateSentencesLearnedList();
         }

         // í•™ìŠµí•œ ë‹¨ì–´ ëª©ë¡ ì—…ë°ì´íŠ¸
         updateWordsLearnedList() {
             const wordsList = document.getElementById('words-learned-list');
             const wordsCount = document.getElementById('words-learned-count');
             
             if (!wordsList) return;

             // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
             if (wordsCount) {
                 wordsCount.textContent = `${this.wordsLearned}ê°œ`;
             }

             // ë¹ˆ ìƒíƒœ ì²´í¬
             if (this.wordsLearned === 0) {
                 wordsList.innerHTML = `
                     <div class="empty-state">
                         <div class="empty-icon">ğŸ“–</div>
                         <p>ì•„ì§ í•™ìŠµí•œ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                         <small>ë‹¨ì–´ë¥¼ í´ë¦­í•˜ì—¬ í•™ìŠµì„ ì‹œì‘í•´ë³´ì„¸ìš”!</small>
                     </div>
                 `;
                 return;
             }

             // í•™ìŠµí•œ ë‹¨ì–´ ëª©ë¡ ìƒì„±
             const wordsHTML = Array.from(this.learnedWords.entries())
                 .map(([wordId, wordData]) => `
                     <div class="learned-item completed" data-word-id="${wordId}">
                         <div class="learned-item-icon word">W</div>
                         <div class="learned-item-content">
                             <div class="learned-item-text">${wordData.text}</div>
                             <div class="learned-item-translation">${wordData.translation}</div>
                         </div>
                         <div class="learned-item-time">${wordData.time}</div>
                     </div>
                 `).join('');

             //wordsList.innerHTML = wordsHTML;

             // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
             const learnedItems = wordsList.querySelectorAll('.learned-item');
             learnedItems.forEach(item => {
                 item.addEventListener('click', () => {
                     const wordId = item.dataset.wordId;
                     const wordData = this.learnedWords.get(wordId);
                     if (wordData) {
                         this.speakText(wordData.text);
                         this.showToast('ë‹¨ì–´ ì¬ìƒ', `"${wordData.text}" ë°œìŒì„ ì¬ìƒí•©ë‹ˆë‹¤.`);
                     }
                 });
             });
         }

         // í•™ìŠµí•œ ë¬¸ì¥ ëª©ë¡ ì—…ë°ì´íŠ¸
         updateSentencesLearnedList() {
             const sentencesList = document.getElementById('sentences-learned-list');
             const sentencesCount = document.getElementById('sentences-learned-count');
             
             if (!sentencesList) return;

             // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
             if (sentencesCount) {
                 sentencesCount.textContent = `${this.sentencesLearned}ê°œ`;
             }

             // ë¹ˆ ìƒíƒœ ì²´í¬
             if (this.sentencesLearned === 0) {
                 sentencesList.innerHTML = `
                     <div class="empty-state">
                         <div class="empty-icon">ğŸ“„</div>
                         <p>ì•„ì§ í•™ìŠµí•œ ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤</p>
                         <small>ë¬¸ì¥ì„ í´ë¦­í•˜ì—¬ í•™ìŠµì„ ì‹œì‘í•´ë³´ì„¸ìš”!</small>
                     </div>
                 `;
                 return;
             }

             // í•™ìŠµí•œ ë¬¸ì¥ ëª©ë¡ ìƒì„±
             const sentencesHTML = Array.from(this.learnedSentences.entries())
                 .map(([sentenceId, sentenceData]) => `
                     <div class="learned-item completed" data-sentence-id="${sentenceId}">
                         <div class="learned-item-icon sentence">S</div>
                         <div class="learned-item-content">
                             <div class="learned-item-text">${sentenceData.text}</div>
                             <div class="learned-item-translation">${sentenceData.translation}</div>
                         </div>
                         <div class="learned-item-time">${sentenceData.time}</div>
                     </div>
                 `).join('');

             sentencesList.innerHTML = sentencesHTML;

             // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
             const learnedItems = sentencesList.querySelectorAll('.learned-item');
             learnedItems.forEach(item => {
                 item.addEventListener('click', () => {
                     const sentenceId = item.dataset.sentenceId;
                     const sentenceData = this.learnedSentences.get(sentenceId);
                     if (sentenceData) {
                         this.speakText(sentenceData.text);
                         this.showToast('ë¬¸ì¥ ì¬ìƒ', `"${sentenceData.text}" ë°œìŒì„ ì¬ìƒí•©ë‹ˆë‹¤.`);
                     }
                 });
             });
         }

        // í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
        showToast(title, description) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                    <div class="toast-title">${title}</div>
                    <div class="toast-description">${description}</div>
                `;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸°
        hideLoading() {
            const loading = document.getElementById('loading');

            if (loading) {
                loading.style.opacity = '0';
                setTimeout(() => {
                    loading.style.display = 'none';
                }, 300);
            }
        }

 
    }

    // ì•± ì´ˆê¸°í™” (DOM ë¡œë“œ ì™„ë£Œ í›„)
    document.addEventListener('DOMContentLoaded', () => {
        console.log('ğŸŒ DOM ë¡œë“œ ì™„ë£Œ');
        window.kiribocaApp = new KiribocaApp();
    });

    // ê°œë°œì ë„êµ¬ìš© ë””ë²„ê¹… í•¨ìˆ˜
    window.debugKiriboca = {
        navigateTo: (page) => window.kiribocaApp.navigateTo(page),
        showToast: (title, desc) => window.kiribocaApp.showToast(title, desc),
        currentPage: () => window.kiribocaApp.currentPage,
        initAdmin: () => window.initAdminDashboard() // ìˆ˜ë™ ê´€ë¦¬ì ì´ˆê¸°í™”
    };
</script>
<!-- JavaScript íŒŒì¼ë“¤ (ìºì‹œ ë²„ìŠ¤íŒ…) - í•œ ë²ˆë§Œ ë¡œë“œ -->
    <script th:src="@{/js/badge-collection.js?v=1.0.2}" defer></script>
    <script th:src="@{/js/dragNdrop.js?v=1.0.2}" defer></script>
    <script th:src="@{/js/main-content.js?v=1.0.2}" defer></script>
    <script th:src="@{/js/change-cards.js?v=1.0.2}" defer></script>
    <script th:src="@{/js/dark-mode.js?v=1.0.2}" defer></script>
    <script th:src="@{/js/admin.js?v=1.0.2}" onload="console.log('âœ… admin.js ë¡œë“œ ì™„ë£Œ')" onerror="console.error('âŒ admin.js ë¡œë“œ ì‹¤íŒ¨')" defer></script>
    <script th:src="@{/js/dashboard.js?v=1.0.2}" onload="console.log('âœ… dashboard.js ë¡œë“œ ì™„ë£Œ')" onerror="console.error('âŒ dashboard.js ë¡œë“œ ì‹¤íŒ¨')" defer></script>
    <script th:src="@{/js/admin-student-management.js?v=1.0.2}" onload="console.log('âœ… admin-student-management.js ë¡œë“œ ì™„ë£Œ')" onerror="console.error('âŒ admin-student-management.js ë¡œë“œ ì‹¤íŒ¨')" defer></script>
</body>
</html>