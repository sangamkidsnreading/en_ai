<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÌÇ§Î¶¨Î≥¥Ïπ¥</title>

    <!-- CSS ÌååÏùºÎì§ ÎßÅÌÅ¨ -->
    <link rel="stylesheet" th:href="@{/student/kiriboca/css/main.css}">
    <link rel="stylesheet" th:href="@{/student/kiriboca/css/sidebar.css}">
    <link rel="stylesheet" th:href="@{/student/kiriboca/css/dashboard.css}">
    <link rel="stylesheet" th:href="@{/student/kiriboca/css/profile.css}">
    <link rel="stylesheet" th:href="@{/student/kiriboca/css/admin.css}">
    <link rel="stylesheet" th:href="@{/student/kiriboca/css/admin-student-management.css}">

    <!-- Chart.js ÎùºÏù¥Î∏åÎü¨Î¶¨ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <!-- Ï§ëÎ≥µ Î°úÎìú Î∞©ÏßÄ Ïä§ÌÅ¨Î¶ΩÌä∏ -->
    <script>
        // Ï§ëÎ≥µ ÏÑ†Ïñ∏ Î∞©ÏßÄ
        if (typeof window.EnhancedIntegratedLearningManager !== 'undefined') {
            delete window.EnhancedIntegratedLearningManager;
        }
        if (typeof window.enhancedIntegratedLearningManager !== 'undefined') {
            delete window.enhancedIntegratedLearningManager;
        }
        if (typeof window.DarkModeManager !== 'undefined') {
            delete window.DarkModeManager;
        }
        if (typeof window.CardChangeManager !== 'undefined') {
            delete window.CardChangeManager;
        }
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #f8f9fa;
        }

        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        #sidebar-container {
            width: 250px;
            flex-shrink: 0;
            border-right: 1px solid #e9ecef;
            /*background: white;*/
        }

        #main-content-container {
            flex: 1;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #52C41A;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #666;
            font-size: 16px;
        }

        /* ÌéòÏù¥ÏßÄ Ïª®ÌÖåÏù¥ÎÑà */
        .page-container {
            display: none;
            width: 100%;
            margin: 0;
            padding: 20px 30px;
            min-height: 100vh;
        }

        .page-container.active {
            display: block;
        }

        /* Ïï†ÎãàÎ©îÏù¥ÏÖò */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ÌÜ†Ïä§Ìä∏ */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .toast-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .toast-description {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
<!-- Î°úÎî© ÌôîÎ©¥ -->
<div id="loading" class="loading">
    <div class="loading-spinner"></div>
    <div class="loading-text">ÌÇ§Î¶¨Î≥¥Ïπ¥ Î°úÎî©Ï§ë...</div>
</div>

<!-- Î©îÏù∏ Ïï± Ïª®ÌÖåÏù¥ÎÑà -->
<div class="app-container">
    <!-- ÏÇ¨Ïù¥ÎìúÎ∞î ÏòÅÏó≠ -->
    <div id="sidebar-container">
        <div th:replace="~{student/kiriboca/components/sidebar :: sidebar}"></div>
    </div>

    <!-- Î©îÏù∏ ÏΩòÌÖêÏ∏† ÏòÅÏó≠ -->
    <div id="main-content-container">
        <!-- ÌïôÏäµÌïòÍ∏∞ ÌéòÏù¥ÏßÄ (Í∏∞Î≥∏) -->
        <div id="learning-page" class="page-container active">
            <div th:replace="~{student/kiriboca/components/main-content :: main-content}"></div>
        </div>

        <!-- ÎåÄÏãúÎ≥¥Îìú ÌéòÏù¥ÏßÄ -->
        <div id="dashboard-page" class="page-container">
            <div th:replace="~{student/kiriboca/components/dashboard :: dashboard-content}"></div>
        </div>

        <!-- ÌîÑÎ°úÌïÑ ÌéòÏù¥ÏßÄ -->
        <div id="profile-page" class="page-container">
            <div th:replace="~{student/kiriboca/components/profile :: profile-content}"></div>
        </div>

        <!-- Í¥ÄÎ¶¨Ïûê ÌéòÏù¥ÏßÄ -->
        <div id="admin-page" class="page-container">
            <div th:replace="~{student/kiriboca/components/admin :: admin-content}"></div>
        </div>

        <!-- ÌïôÏÉù Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄ (ADMIN, TEACHER Ï†ÑÏö©) -->
        <div id="admin-student-management-page" class="page-container">
            <div th:replace="~{student/kiriboca/components/admin-student-management :: adminStudentManagement}"></div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script th:inline="javascript">
    <!-- ÌÇ§Î¶¨Î≥¥Ïπ¥ Ïï± ÌÅ¥ÎûòÏä§ -->
    class KiribocaApp {
        constructor() {
            this.currentPage = 'learning';
            this.isLoading = false;
            this.wordsLearned = 0;
            this.sentencesLearned = 0;
            this.totalCoins = 0;
            this.learnedWords = new Map(); // wordId -> {text, translation, time}
            this.learnedSentences = new Map(); // sentenceId -> {text, translation, time}
            this.favoriteWords = new Set();
            this.init();
        }

        // Ïï± Ï¥àÍ∏∞Ìôî
        async init() {
            console.log('üöÄ ÌÇ§Î¶¨Î≥¥Ïπ¥ Ïï± ÏãúÏûë');

            try {
                // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
                this.setupEventListeners();

                // API Ïó∞Í≤∞ ÏÉÅÌÉú ÌôïÏù∏ Î∞è Ïû¨ÏãúÎèÑ
                await this.checkApiConnection();

                // Î°úÎî© ÏôÑÎ£å
                this.hideLoading();

                // Ïò§Îäò ÌïôÏäµ ÏßÑÌñâÏÉÅÌô© Î∂àÎü¨Ïò§Í∏∞
                await this.fetchTodayProgress();

                console.log('‚úÖ ÌÇ§Î¶¨Î≥¥Ïπ¥ Ïï± Î°úÎìú ÏôÑÎ£å');
            } catch (error) {
                console.error('‚ùå Ïï± Î°úÎìú Ï§ë Ïò§Î•ò:', error);
                /*this.showToast('Ïò§Î•ò', 'Ïï±ÏùÑ Î°úÎìúÌïòÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');*/
            }
        }

        // API Ïó∞Í≤∞ ÏÉÅÌÉú ÌôïÏù∏
        async checkApiConnection() {
            console.log('üîç API Ïó∞Í≤∞ ÏÉÅÌÉú ÌôïÏù∏');

            try {
                const response = await fetch('/api/sidebar/levels');
                if (!response.ok) {
                    console.log('‚ö†Ô∏è API Ïó∞Í≤∞ Ïã§Ìå®, Ïû¨ÏãúÎèÑ Ï§ë...');
                    // 3Ï¥à ÌõÑ Ïû¨ÏãúÎèÑ
                    setTimeout(() => {
                        location.reload();
                    }, 3000);
                } else {
                    console.log('‚úÖ API Ïó∞Í≤∞ ÏÑ±Í≥µ');
                }
            } catch (error) {
                console.error('‚ùå API Ïó∞Í≤∞ ÌôïÏù∏ Ïã§Ìå®:', error);
                this.showToast('Ïó∞Í≤∞ Ïò§Î•ò', 'API ÏÑúÎ≤ÑÏôÄ Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
            }
        }

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        setupEventListeners() {
            console.log('üîó Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï');

            setTimeout(() => {
                this.setupNavigationEvents();

                // Ìñ•ÏÉÅÎêú ÌÜµÌï© ÌïôÏäµ Í¥ÄÎ¶¨ÏûêÍ∞Ä ÏûàÏúºÎ©¥ ÌïôÏäµ Ïù¥Î≤§Ìä∏Îäî ÏÑ§Ï†ïÌïòÏßÄ ÏïäÏùå
                if (!window.enhancedIntegratedLearningManager) {
                this.setupLearningPageEvents();
                } else {
                    console.log('üîÑ Ìñ•ÏÉÅÎêú ÌÜµÌï© ÌïôÏäµ Í¥ÄÎ¶¨ÏûêÍ∞Ä ÏûàÏúºÎØÄÎ°ú Í∏∞Î≥∏ ÌïôÏäµ Ïù¥Î≤§Ìä∏ Ïä§ÌÇµ');
                }

                                 this.setupAdminEvents();
                 this.setupProfileEvents();
                 this.updateDisplay();
                 this.updateLearnedLists();
            }, 100);
        }

        // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
        setupNavigationEvents() {
            const navItems = document.querySelectorAll('.nav-item[data-page]');

            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = item.dataset.page;

                    if (page && page !== this.currentPage) {
                        this.navigateTo(page);
                    }
                });

                // Ìò∏Î≤Ñ Ìö®Í≥º
                item.addEventListener('mouseenter', () => {
                    if (!item.classList.contains('active')) {
                        item.style.transform = 'translateX(2px)';
                        /*item.style.background = '#f8f9fa';*/
                    }
                });

                item.addEventListener('mouseleave', () => {
                    if (!item.classList.contains('active')) {
                        item.style.transform = 'translateX(0)';
                        item.style.background = 'none';
                    }
                });
            });

            console.log('üß≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï ÏôÑÎ£å');
        }

        // ÌïôÏäµ ÌéòÏù¥ÏßÄ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
        setupLearningPageEvents() {
            console.log('üìö ÌïôÏäµ ÌéòÏù¥ÏßÄ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï');

            // Ìñ•ÏÉÅÎêú ÌÜµÌï© ÌïôÏäµ Í¥ÄÎ¶¨ÏûêÍ∞Ä ÏûàÏúºÎ©¥ Í∏∞Î≥∏ Ïù¥Î≤§Ìä∏Îäî ÏÑ§Ï†ïÌïòÏßÄ ÏïäÏùå
            if (window.enhancedIntegratedLearningManager) {
                console.log('üîÑ Ìñ•ÏÉÅÎêú ÌÜµÌï© ÌïôÏäµ Í¥ÄÎ¶¨ÏûêÍ∞Ä ÏûàÏúºÎØÄÎ°ú Í∏∞Î≥∏ ÌïôÏäµ Ïù¥Î≤§Ìä∏ Ïä§ÌÇµ');
                return;
            }

            // Îã®Ïñ¥ Ïπ¥Îìú Ïù¥Î≤§Ìä∏
            const wordCards = document.querySelectorAll('.word-card');
            wordCards.forEach(card => {
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('.word-favorite')) {
                        this.handleWordClick(card);
                    }
                });

                // Ï¶êÍ≤®Ï∞æÍ∏∞ Î≤ÑÌäº
                const favoriteBtn = card.querySelector('.word-favorite');
                if (favoriteBtn) {
                    favoriteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.toggleWordFavorite(card);
                    });
                }
            });

            // Î¨∏Ïû• Ïπ¥Îìú Ïù¥Î≤§Ìä∏
            const sentenceCards = document.querySelectorAll('.sentence-card');
            sentenceCards.forEach(card => {
                card.addEventListener('click', () => {
                    this.handleSentenceClick(card);
                });
            });

                         // Start Î≤ÑÌäº Ïù¥Î≤§Ìä∏
             const wordsStartBtn = document.getElementById('words-start-btn');
             const sentencesStartBtn = document.getElementById('sentences-start-btn');
             
             if (wordsStartBtn) {
                 wordsStartBtn.addEventListener('click', () => {
                     this.handleWordsStart();
                 });
             }
             
             if (sentencesStartBtn) {
                 sentencesStartBtn.addEventListener('click', () => {
                     this.handleSentencesStart();
                 });
             }

            // Í≤ÄÏÉâ Í∏∞Îä•
            const searchInput = document.querySelector('.search-input');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    this.handleSearch(e.target.value);
                });
            }
        }

        // Í¥ÄÎ¶¨Ïûê Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
        setupAdminEvents() {
            console.log('‚öôÔ∏è Í¥ÄÎ¶¨Ïûê Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï');

            // Í∏∞Ï°¥ navigateTo Î©îÏÑúÎìúÎ•º ÌôïÏû•ÌïòÏó¨ Í¥ÄÎ¶¨Ïûê ÌéòÏù¥ÏßÄ ÏßÑÏûÖ Ïãú AdminDashboard Ï¥àÍ∏∞Ìôî
            const originalNavigateTo = this.navigateTo.bind(this);

            this.navigateTo = function(page) {
                console.log(`üìÑ ÌéòÏù¥ÏßÄ Ïù¥Îèô: ${this.currentPage} ‚Üí ${page}`);

                // Í∏∞Ï°¥ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î°úÏßÅ Ïã§Ìñâ
                originalNavigateTo(page);

                // Í¥ÄÎ¶¨Ïûê ÌéòÏù¥ÏßÄÎ°ú Ï†ÑÌôòÎêú Í≤ΩÏö∞ AdminDashboard Ï¥àÍ∏∞Ìôî
                if (page === 'admin') {
                    console.log('üîß Í¥ÄÎ¶¨Ïûê ÌéòÏù¥ÏßÄ ÏßÑÏûÖ - AdminDashboard Ï¥àÍ∏∞Ìôî ÏòàÏïΩ');

                    // ÌååÏùº Î°úÎìú ÌôïÏù∏ Î∞è Ï¥àÍ∏∞Ìôî
                    const initAdmin = () => {
                        console.log('üîß AdminDashboard Ï¥àÍ∏∞Ìôî Ïã§Ìñâ');

                        // admin.jsÏùò Ï¥àÍ∏∞Ìôî Ìï®Ïàò Ìò∏Ï∂ú
                        if (typeof window.initAdminDashboard === 'function') {
                            window.initAdminDashboard();
                            console.log('‚úÖ AdminDashboard Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
                        } else {
                            console.error('‚ùå admin.jsÍ∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. ÌååÏùº Í≤ΩÎ°úÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.');
                            console.log('üîç ÎîîÎ≤ÑÍ∑∏: window Í∞ùÏ≤¥ÏóêÏÑú admin Í¥ÄÎ†® Ìï®ÏàòÎì§:',
                                Object.keys(window).filter(key => key.includes('admin') || key.includes('Admin')));

                            // Ïû¨ÏãúÎèÑ Î°úÏßÅ Ï∂îÍ∞Ä
                            console.log('üîÑ admin.js Î°úÎìú Ïû¨ÏãúÎèÑ Ï§ë...');
                            setTimeout(() => {
                                if (typeof window.initAdminDashboard === 'function') {
                                    window.initAdminDashboard();
                                    console.log('‚úÖ AdminDashboard Ïû¨ÏãúÎèÑ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
                                } else {
                                    console.error('‚ùå admin.js Î°úÎìú Ïã§Ìå® - ÏàòÎèôÏúºÎ°ú ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.');
                                }
                            }, 1000);
                        }
                    };

                    // DOMÏù¥ ÏôÑÏ†ÑÌûà Î°úÎìúÎê† ÎïåÍπåÏßÄ Ï∂©Î∂ÑÌûà ÎåÄÍ∏∞
                    setTimeout(initAdmin, 300);
                }
            };
        }

        // ÌîÑÎ°úÌïÑ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
        setupProfileEvents() {
            console.log('üë§ ÌîÑÎ°úÌïÑ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï');

            setTimeout(() => {
                // ÌÜ†Í∏Ä Ïä§ÏúÑÏπò Í∏∞Îä•
                const toggleSwitches = document.querySelectorAll('.toggle-switch input');
                toggleSwitches.forEach(toggle => {
                    toggle.addEventListener('change', (e) => {
                        console.log(`ÏÑ§Ï†ï Î≥ÄÍ≤Ω: ${e.target.id} = ${e.target.checked}`);
                        this.showToast('ÏÑ§Ï†ï Î≥ÄÍ≤Ω', `${e.target.id} ÏÑ§Ï†ïÏù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`);
                    });
                });

                // Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
                const updateBtns = document.querySelectorAll('.update-btn, .avatar-btn');
                updateBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const btnText = e.target.textContent;
                        this.showToast('Í∏∞Îä• Ï§ÄÎπÑÏ§ë', `${btnText} Í∏∞Îä•ÏùÄ Ï§ÄÎπÑÏ§ëÏûÖÎãàÎã§.`);
                    });
                });
            }, 200);
        }

        // ÌéòÏù¥ÏßÄ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò (Í∏∞Ï°¥ Î©îÏÑúÎìúÎäî setupAdminEventsÏóêÏÑú Ïò§Î≤ÑÎùºÏù¥ÎìúÎê®)
        navigateTo(page) {
            console.log(`üìÑ ÌéòÏù¥ÏßÄ Ïù¥Îèô: ${this.currentPage} ‚Üí ${page}`);

            if (this.isLoading) {
                console.log('‚è≥ Ïù¥ÎØ∏ Î°úÎî© Ï§ëÏûÖÎãàÎã§...');
                return;
            }

            // ÌäπÎ≥Ñ Ï≤òÎ¶¨ (Î°úÍ∑∏ÏïÑÏõÉ)
            if (page === 'logout') {
                window.location.replace('/logout');
                return;
            }

            // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            this.updateNavigationState(page);

            // ÌéòÏù¥ÏßÄ Ï†ÑÌôò
            this.switchPage(page);

            // ÌïôÏÉù Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄÏù∏ Í≤ΩÏö∞ StudentManagementManager Ï¥àÍ∏∞Ìôî
            if (page === 'admin-student-management') {
                console.log('üîß ÌïôÏÉù Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄ ÏßÑÏûÖ - StudentManagementManager Ï¥àÍ∏∞Ìôî');
                setTimeout(() => {
                    if (typeof window.initStudentManagementManager === 'function') {
                        window.initStudentManagementManager();
                        console.log('‚úÖ StudentManagementManager Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
                    } else {
                        console.error('‚ùå admin-student-management.jsÍ∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                    }
                }, 100);
            }

            this.currentPage = page;
        }

        // ÌéòÏù¥ÏßÄ Ï†ÑÌôò
        switchPage(targetPage) {
            // Î™®Îì† ÌéòÏù¥ÏßÄ Ïà®Í∏∞Í∏∞
            const allPages = document.querySelectorAll('.page-container');
            allPages.forEach(page => {
                page.classList.remove('active');
            });

            // ÎåÄÏÉÅ ÌéòÏù¥ÏßÄ ÌëúÏãú
            let targetPageElement;
            
            // ÌéòÏù¥ÏßÄ ID Îß§Ìïë
            const pageIdMap = {
                'learning': 'learning-page',
                'dashboard': 'dashboard-page',
                'profile': 'profile-page',
                'admin': 'admin-page',
                'admin-student-management': 'admin-student-management-page'
            };
            
            const pageId = pageIdMap[targetPage] || `${targetPage}-page`;
            targetPageElement = document.getElementById(pageId);
            
            if (targetPageElement) {
                targetPageElement.classList.add('active');
                targetPageElement.classList.add('fade-in');
                console.log(`‚úÖ ÌéòÏù¥ÏßÄ Ï†ÑÌôò ÏôÑÎ£å: ${targetPage} (${pageId})`);
            } else {
                console.error(`‚ùå ÌéòÏù¥ÏßÄÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§: ${pageId}`);
            }
        }

        // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        updateNavigationState(page) {
            // Î™®Îì† ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÏïÑÏù¥ÌÖú ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // ÏÉàÎ°úÏö¥ ÌôúÏÑ± ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÏïÑÏù¥ÌÖú ÏÑ§Ï†ï
            const activeNavItem = document.querySelector(`[data-page="${page}"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
                console.log(`üß≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏: ${page}`);
            } else {
                console.warn(`‚ö†Ô∏è ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÏïÑÏù¥ÌÖúÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§: ${page}`);
            }
        }

        // ÌéòÏù¥ÏßÄ Ï†úÎ™© Î∞òÌôò
        getPageTitle(page) {
            const titles = {
                'learning': 'ÌïôÏäµÌïòÍ∏∞',
                'dashboard': 'ÎåÄÏãúÎ≥¥Îìú',
                'profile': 'ÌîÑÎ°úÌïÑ',
                'admin': 'Í¥ÄÎ¶¨Ïûê'
            };
            return titles[page] || page;
        }

                 // Îã®Ïñ¥ ÌÅ¥Î¶≠ Ï≤òÎ¶¨
         handleWordClick(card) {
             const wordId = card.dataset.word || Math.random().toString(36).substr(2, 9);
             const wordText = card.querySelector('.word-english')?.textContent || 'Unknown Word';
             const wordTranslation = card.querySelector('.word-korean')?.textContent || '';

             // TTS Ïû¨ÏÉù
             this.speakText(wordText);

             // ÏãúÍ∞ÅÏ†Å ÌîºÎìúÎ∞±
             card.style.transform = 'scale(1.05)';
             setTimeout(() => {
                 card.style.transform = 'scale(1)';
             }, 200);

             // ÌïôÏäµ ÏôÑÎ£å Ï≤òÎ¶¨
             if (!this.learnedWords.has(wordId)) {
                 const now = new Date();
                 this.learnedWords.set(wordId, {
                     text: wordText,
                     translation: wordTranslation,
                     time: now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
                 });
                 this.wordsLearned++;
                 this.totalCoins += 1;

                 card.style.background = '#e6f7ff';
                 card.style.borderColor = '#91d5ff';

                 this.updateDisplay();
                 this.updateLearnedLists();
                 this.showToast('Îã®Ïñ¥ ÌïôÏäµ ÏôÑÎ£å', `"${wordText}" ÌïôÏäµ ÏôÑÎ£å! +1 ÏΩîÏù∏`);
             }
         }

                 // Î¨∏Ïû• ÌÅ¥Î¶≠ Ï≤òÎ¶¨
         handleSentenceClick(card) {
             const sentenceId = card.dataset.sentence || Math.random().toString(36).substr(2, 9);
             const sentenceText = card.querySelector('.sentence-text')?.textContent || 'Unknown Sentence';
             const sentenceTranslation = card.querySelector('.sentence-translation')?.textContent || '';

             // TTS Ïû¨ÏÉù
             this.speakText(sentenceText);

             // ÏãúÍ∞ÅÏ†Å ÌîºÎìúÎ∞±
             card.style.transform = 'scale(1.02)';
             setTimeout(() => {
                 card.style.transform = 'scale(1)';
             }, 200);

             // ÌïôÏäµ ÏôÑÎ£å Ï≤òÎ¶¨
             if (!this.learnedSentences.has(sentenceId)) {
                 const now = new Date();
                 this.learnedSentences.set(sentenceId, {
                     text: sentenceText,
                     translation: sentenceTranslation,
                     time: now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
                 });
                 this.sentencesLearned++;
                 this.totalCoins += 3;

                 card.style.background = '#f6ffed';
                 card.style.borderColor = '#b7eb8f';

                 this.updateDisplay();
                 this.updateLearnedLists();
                 this.showToast('Î¨∏Ïû• ÌïôÏäµ ÏôÑÎ£å', `"${sentenceText}" ÌïôÏäµ ÏôÑÎ£å! +3 ÏΩîÏù∏`);
             }
         }

        // Ï¶êÍ≤®Ï∞æÍ∏∞ ÌÜ†Í∏Ä
        toggleWordFavorite(card) {
            const wordId = card.dataset.word || Math.random().toString(36).substr(2, 9);
            const favoriteBtn = card.querySelector('.word-favorite');

            if (this.favoriteWords.has(wordId)) {
                this.favoriteWords.delete(wordId);
                favoriteBtn.textContent = '‚ô°';
            } else {
                this.favoriteWords.add(wordId);
                favoriteBtn.textContent = '‚ù§Ô∏è';
            }

            // Ïï†ÎãàÎ©îÏù¥ÏÖò Ìö®Í≥º
            favoriteBtn.style.transform = 'scale(1.3)';
            setTimeout(() => {
                favoriteBtn.style.transform = 'scale(1)';
            }, 200);
        }

                 // Îã®Ïñ¥ ÌïôÏäµ ÏãúÏûë
         handleWordsStart() {
             const wordCards = document.querySelectorAll('.word-card');
             if (wordCards.length === 0) {
                 // ÏÉòÌîå Îã®Ïñ¥ Ïπ¥Îìú ÏÉùÏÑ±
                 this.generateSampleWords();
                 return;
             }

             let currentIndex = 0;
             const totalCards = wordCards.length;

             const playNext = () => {
                 if (currentIndex >= totalCards) {
                     this.showToast('Îã®Ïñ¥ ÌïôÏäµ ÏôÑÎ£å!', `${totalCards}Í∞úÏùò Îã®Ïñ¥Î•º Î™®Îëê ÌïôÏäµÌñàÏäµÎãàÎã§.`);
                     return;
                 }

                 const card = wordCards[currentIndex];
                 this.handleWordClick(card);
                 currentIndex++;

                 setTimeout(playNext, 2000);
             };

             playNext();
             this.showToast('Îã®Ïñ¥ ÏûêÎèô ÌïôÏäµ ÏãúÏûë', 'Î™®Îì† Îã®Ïñ¥Î•º ÏàúÏ∞®Ï†ÅÏúºÎ°ú ÌïôÏäµÌï©ÎãàÎã§.');
         }

         // Î¨∏Ïû• ÌïôÏäµ ÏãúÏûë
         handleSentencesStart() {
             const sentenceCards = document.querySelectorAll('.sentence-card');
             if (sentenceCards.length === 0) {
                 // ÏÉòÌîå Î¨∏Ïû• Ïπ¥Îìú ÏÉùÏÑ±
                 this.generateSampleSentences();
                 return;
             }

             let currentIndex = 0;
             const totalCards = sentenceCards.length;

             const playNext = () => {
                 if (currentIndex >= totalCards) {
                     this.showToast('Î¨∏Ïû• ÌïôÏäµ ÏôÑÎ£å!', `${totalCards}Í∞úÏùò Î¨∏Ïû•ÏùÑ Î™®Îëê ÌïôÏäµÌñàÏäµÎãàÎã§.`);
                     return;
                 }

                 const card = sentenceCards[currentIndex];
                 this.handleSentenceClick(card);
                 currentIndex++;

                 setTimeout(playNext, 3000);
             };

             playNext();
             this.showToast('Î¨∏Ïû• ÏûêÎèô ÌïôÏäµ ÏãúÏûë', 'Î™®Îì† Î¨∏Ïû•ÏùÑ ÏàúÏ∞®Ï†ÅÏúºÎ°ú ÌïôÏäµÌï©ÎãàÎã§.');
         }

         // ÏÉòÌîå Îã®Ïñ¥ Ïπ¥Îìú ÏÉùÏÑ±
         generateSampleWords() {
             const wordsGrid = document.getElementById('words-grid');
             if (!wordsGrid) return;

             const sampleWords = [
                 { english: 'apple', korean: 'ÏÇ¨Í≥º', audio: 'apple.mp3' },
                 { english: 'banana', korean: 'Î∞îÎÇòÎÇò', audio: 'banana.mp3' },
                 { english: 'cat', korean: 'Í≥†ÏñëÏù¥', audio: 'cat.mp3' },
                 { english: 'dog', korean: 'Í∞ïÏïÑÏßÄ', audio: 'dog.mp3' },
                 { english: 'elephant', korean: 'ÏΩîÎÅºÎ¶¨', audio: 'elephant.mp3' },
                 { english: 'flower', korean: 'ÍΩÉ', audio: 'flower.mp3' },
                 { english: 'garden', korean: 'Ï†ïÏõê', audio: 'garden.mp3' },
                 { english: 'house', korean: 'Ïßë', audio: 'house.mp3' },
                 { english: 'ice cream', korean: 'ÏïÑÏù¥Ïä§ÌÅ¨Î¶º', audio: 'icecream.mp3' },
                 { english: 'juice', korean: 'Ï£ºÏä§', audio: 'juice.mp3' }
             ];

             const wordsHTML = sampleWords.map((word, index) => `
                 <div class="word-card" data-word="word-${index}">
                     <div class="word-content">
                         <div class="word-english">${word.english}</div>
                         <div class="word-korean">${word.korean}</div>
                     </div>
                     <div class="word-actions">
                         <button class="word-favorite">‚ô°</button>
                         <button class="word-audio" onclick="window.kiribocaApp.speakText('${word.english}')">üîä</button>
                     </div>
                 </div>
             `).join('');

             wordsGrid.innerHTML = wordsHTML;

             // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îã§Ïãú ÏÑ§Ï†ï
             this.setupLearningPageEvents();
             this.showToast('ÏÉòÌîå Îã®Ïñ¥ Î°úÎìú', '10Í∞úÏùò ÏÉòÌîå Îã®Ïñ¥Í∞Ä Î°úÎìúÎêòÏóàÏäµÎãàÎã§.');
         }

         // ÏÉòÌîå Î¨∏Ïû• Ïπ¥Îìú ÏÉùÏÑ±
         generateSampleSentences() {
             const sentencesGrid = document.getElementById('sentences-grid');
             if (!sentencesGrid) return;

             const sampleSentences = [
                 { english: 'I like apples.', korean: 'ÎÇòÎäî ÏÇ¨Í≥ºÎ•º Ï¢ãÏïÑÌï©ÎãàÎã§.', audio: 'sentence1.mp3' },
                 { english: 'The cat is sleeping.', korean: 'Í≥†ÏñëÏù¥Í∞Ä ÏûêÍ≥† ÏûàÏäµÎãàÎã§.', audio: 'sentence2.mp3' },
                 { english: 'This is my house.', korean: 'Ïù¥Í≤ÉÏùÄ ÎÇ¥ ÏßëÏûÖÎãàÎã§.', audio: 'sentence3.mp3' },
                 { english: 'I want ice cream.', korean: 'ÏïÑÏù¥Ïä§ÌÅ¨Î¶ºÏùÑ ÏõêÌï©ÎãàÎã§.', audio: 'sentence4.mp3' },
                 { english: 'The flower is beautiful.', korean: 'ÍΩÉÏù¥ ÏïÑÎ¶ÑÎãµÏäµÎãàÎã§.', audio: 'sentence5.mp3' }
             ];

             const sentencesHTML = sampleSentences.map((sentence, index) => `
                 <div class="sentence-card" data-sentence="sentence-${index}">
                     <div class="sentence-content">
                         <div class="sentence-text">${sentence.english}</div>
                         <div class="sentence-translation">${sentence.korean}</div>
                     </div>
                     <div class="sentence-actions">
                         <button class="sentence-audio" onclick="window.kiribocaApp.speakText('${sentence.english}')">üîä</button>
                     </div>
                 </div>
             `).join('');

             sentencesGrid.innerHTML = sentencesHTML;

             // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îã§Ïãú ÏÑ§Ï†ï
             this.setupLearningPageEvents();
             this.showToast('ÏÉòÌîå Î¨∏Ïû• Î°úÎìú', '5Í∞úÏùò ÏÉòÌîå Î¨∏Ïû•Ïù¥ Î°úÎìúÎêòÏóàÏäµÎãàÎã§.');
         }

        // Í≤ÄÏÉâ Ï≤òÎ¶¨
        handleSearch(query) {
            // Í≤ÄÏÉâÏñ¥Í∞Ä ÏßßÏúºÎ©¥ Î™®Îì† Ïπ¥Îìú ÌëúÏãú (ÏïÑÎ¨¥ Ï°∞ÏûëÎèÑ ÌïòÏßÄ ÏïäÏùå)
            if (query.length < 2) {
                return;
            }
            // Í≤ÄÏÉâ Í≤∞Í≥º ÌïÑÌÑ∞ÎßÅÏùÄ JSÏóêÏÑú ÏßÅÏ†ë Ïπ¥Îìú display/visibilityÎ•º Ï°∞ÏûëÌïòÏßÄ ÏïäÍ≥†,
            // main-content.js, app.jsÏóêÏÑúÎßå Îã¥ÎãπÌïòÎèÑÎ°ù!
        }

        // TTS ÏùåÏÑ± Ïû¨ÏÉù
        speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.8;
                speechSynthesis.speak(utterance);
            }
        }

                 // ÎîîÏä§ÌîåÎ†àÏù¥ ÏóÖÎç∞Ïù¥Ìä∏
         updateDisplay() {
             // Ìó§Îçî Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
             const wordsLearnedEl = document.getElementById('words-learned');
             const sentencesLearnedEl = document.getElementById('sentences-learned');
             const totalCoinsEl = document.getElementById('total-coins');

             if (wordsLearnedEl) wordsLearnedEl.textContent = this.wordsLearned;
             if (sentencesLearnedEl) sentencesLearnedEl.textContent = this.sentencesLearned;
             if (totalCoinsEl) totalCoinsEl.textContent = this.totalCoins;
         }

         // ÌïôÏäµÌïú Ìï≠Î™© Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
         updateLearnedLists() {
             this.updateWordsLearnedList();
             this.updateSentencesLearnedList();
         }

         // ÌïôÏäµÌïú Îã®Ïñ¥ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
         updateWordsLearnedList() {
             const wordsList = document.getElementById('words-learned-list');
             const wordsCount = document.getElementById('words-learned-count');
             
             if (!wordsList) return;

             // Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
             if (wordsCount) {
                 wordsCount.textContent = `${this.wordsLearned}Í∞ú`;
             }

             // Îπà ÏÉÅÌÉú Ï≤¥ÌÅ¨
             if (this.wordsLearned === 0) {
                 wordsList.innerHTML = `
                     <div class="empty-state">
                         <div class="empty-icon">üìñ</div>
                         <p>ÏïÑÏßÅ ÌïôÏäµÌïú Îã®Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§</p>
                         <small>Îã®Ïñ¥Î•º ÌÅ¥Î¶≠ÌïòÏó¨ ÌïôÏäµÏùÑ ÏãúÏûëÌï¥Î≥¥ÏÑ∏Ïöî!</small>
                     </div>
                 `;
                 return;
             }

             // ÌïôÏäµÌïú Îã®Ïñ¥ Î™©Î°ù ÏÉùÏÑ±
             const wordsHTML = Array.from(this.learnedWords.entries())
                 .map(([wordId, wordData]) => `
                     <div class="learned-item completed" data-word-id="${wordId}">
                         <div class="learned-item-icon word">W</div>
                         <div class="learned-item-content">
                             <div class="learned-item-text">${wordData.text}</div>
                             <div class="learned-item-translation">${wordData.translation}</div>
                         </div>
                         <div class="learned-item-time">${wordData.time}</div>
                     </div>
                 `).join('');

             //wordsList.innerHTML = wordsHTML;

             // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
             const learnedItems = wordsList.querySelectorAll('.learned-item');
             learnedItems.forEach(item => {
                 item.addEventListener('click', () => {
                     const wordId = item.dataset.wordId;
                     const wordData = this.learnedWords.get(wordId);
                     if (wordData) {
                         this.speakText(wordData.text);
                         this.showToast('Îã®Ïñ¥ Ïû¨ÏÉù', `"${wordData.text}" Î∞úÏùåÏùÑ Ïû¨ÏÉùÌï©ÎãàÎã§.`);
                     }
                 });
             });
         }

         // ÌïôÏäµÌïú Î¨∏Ïû• Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
         updateSentencesLearnedList() {
             const sentencesList = document.getElementById('sentences-learned-list');
             const sentencesCount = document.getElementById('sentences-learned-count');
             
             if (!sentencesList) return;

             // Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
             if (sentencesCount) {
                 sentencesCount.textContent = `${this.sentencesLearned}Í∞ú`;
             }

             // Îπà ÏÉÅÌÉú Ï≤¥ÌÅ¨
             if (this.sentencesLearned === 0) {
                 sentencesList.innerHTML = `
                     <div class="empty-state">
                         <div class="empty-icon">üìÑ</div>
                         <p>ÏïÑÏßÅ ÌïôÏäµÌïú Î¨∏Ïû•Ïù¥ ÏóÜÏäµÎãàÎã§</p>
                         <small>Î¨∏Ïû•ÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÌïôÏäµÏùÑ ÏãúÏûëÌï¥Î≥¥ÏÑ∏Ïöî!</small>
                     </div>
                 `;
                 return;
             }

             // ÌïôÏäµÌïú Î¨∏Ïû• Î™©Î°ù ÏÉùÏÑ±
             const sentencesHTML = Array.from(this.learnedSentences.entries())
                 .map(([sentenceId, sentenceData]) => `
                     <div class="learned-item completed" data-sentence-id="${sentenceId}">
                         <div class="learned-item-icon sentence">S</div>
                         <div class="learned-item-content">
                             <div class="learned-item-text">${sentenceData.text}</div>
                             <div class="learned-item-translation">${sentenceData.translation}</div>
                         </div>
                         <div class="learned-item-time">${sentenceData.time}</div>
                     </div>
                 `).join('');

             sentencesList.innerHTML = sentencesHTML;

             // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
             const learnedItems = sentencesList.querySelectorAll('.learned-item');
             learnedItems.forEach(item => {
                 item.addEventListener('click', () => {
                     const sentenceId = item.dataset.sentenceId;
                     const sentenceData = this.learnedSentences.get(sentenceId);
                     if (sentenceData) {
                         this.speakText(sentenceData.text);
                         this.showToast('Î¨∏Ïû• Ïû¨ÏÉù', `"${sentenceData.text}" Î∞úÏùåÏùÑ Ïû¨ÏÉùÌï©ÎãàÎã§.`);
                     }
                 });
             });
         }

        // ÌÜ†Ïä§Ìä∏ ÏïåÎ¶º ÌëúÏãú
        showToast(title, description) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                    <div class="toast-title">${title}</div>
                    <div class="toast-description">${description}</div>
                `;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Î°úÎî© ÌôîÎ©¥ Ïà®Í∏∞Í∏∞
        hideLoading() {
            const loading = document.getElementById('loading');

            if (loading) {
                loading.style.opacity = '0';
                setTimeout(() => {
                    loading.style.display = 'none';
                }, 300);
            }
        }

 
    }

    // Ïï± Ï¥àÍ∏∞Ìôî (DOM Î°úÎìú ÏôÑÎ£å ÌõÑ)
    document.addEventListener('DOMContentLoaded', () => {
        console.log('üåê DOM Î°úÎìú ÏôÑÎ£å');
        window.kiribocaApp = new KiribocaApp();
    });

    // Í∞úÎ∞úÏûê ÎèÑÍµ¨Ïö© ÎîîÎ≤ÑÍπÖ Ìï®Ïàò
    window.debugKiriboca = {
        navigateTo: (page) => window.kiribocaApp.navigateTo(page),
        showToast: (title, desc) => window.kiribocaApp.showToast(title, desc),
        currentPage: () => window.kiribocaApp.currentPage,
        initAdmin: () => window.initAdminDashboard() // ÏàòÎèô Í¥ÄÎ¶¨Ïûê Ï¥àÍ∏∞Ìôî
    };
</script>
<!-- JavaScript ÌååÏùºÎì§ (Ï∫êÏãú Î≤ÑÏä§ÌåÖ) - Ìïú Î≤àÎßå Î°úÎìú -->
    <script th:src="@{/js/badge-collection.js?v=1.0.2}" defer></script>
    <script th:src="@{/js/dragNdrop.js?v=1.0.2}" defer></script>
    <script th:src="@{/js/main-content.js?v=1.0.2}" defer></script>
    <script th:src="@{/js/change-cards.js?v=1.0.2}" defer></script>
    <script th:src="@{/js/dark-mode.js?v=1.0.2}" defer></script>
    <script th:src="@{/js/admin.js?v=1.0.2}" onload="console.log('‚úÖ admin.js Î°úÎìú ÏôÑÎ£å')" onerror="console.error('‚ùå admin.js Î°úÎìú Ïã§Ìå®')" defer></script>
    <script th:src="@{/js/dashboard.js?v=1.0.2}" onload="console.log('‚úÖ dashboard.js Î°úÎìú ÏôÑÎ£å')" onerror="console.error('‚ùå dashboard.js Î°úÎìú Ïã§Ìå®')" defer></script>
    <script th:src="@{/js/admin-student-management.js?v=1.0.2}" onload="console.log('‚úÖ admin-student-management.js Î°úÎìú ÏôÑÎ£å')" onerror="console.error('‚ùå admin-student-management.js Î°úÎìú Ïã§Ìå®')" defer></script>
</body>
</html>